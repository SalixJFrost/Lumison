import React, { useRef, useEffect, useState, useMemo } from "react";
import { LyricLine as LyricLineType } from "../types";
import { useI18n } from "../contexts/I18nContext";

interface LyricsViewSimpleProps {
  lyrics: LyricLineType[];
  audioRef: React.RefObject<HTMLAudioElement>;
  isPlaying: boolean;
  currentTime: number;
  onSeekRequest: (time: number, immediate?: boolean) => void;
  matchStatus: "idle" | "matching" | "success" | "failed";
  fontSize?: number;
  accentColor?: string;
}

const LyricsViewSimple: React.FC<LyricsViewSimpleProps> = ({
  lyrics,
  currentTime,
  onSeekRequest,
  matchStatus,
  fontSize = 48,
  accentColor = '#ffffff',
}) => {
  const { t } = useI18n();
  const containerRef = useRef<HTMLDivElement>(null);
  const [activeIndex, setActiveIndex] = useState(-1);

  // Find active lyric line
  useEffect(() => {
    if (!lyrics.length) {
      setActiveIndex(-1);
      return;
    }

    let index = -1;
    for (let i = lyrics.length - 1; i >= 0; i--) {
      if (currentTime >= lyrics[i].time) {
        index = i;
        break;
      }
    }
    setActiveIndex(index);
  }, [currentTime, lyrics]);

  // Find current word in active line for word-by-word highlighting
  const getCurrentWordIndex = (lineIndex: number) => {
    if (lineIndex < 0 || !lyrics[lineIndex]?.words) return -1;
    
    const line = lyrics[lineIndex];
    const words = line.words || [];
    
    for (let i = words.length - 1; i >= 0; i--) {
      if (currentTime >= words[i].startTime) {
        return i;
      }
    }
    return -1;
  };

  // Auto-scroll to active line
  useEffect(() => {
    if (activeIndex < 0 || !containerRef.current) return;

    const activeElement = containerRef.current.querySelector(
      `[data-index="${activeIndex}"]`
    );
    if (activeElement) {
      activeElement.scrollIntoView({
        behavior: "smooth",
        block: "center",
      });
    }
  }, [activeIndex]);

  // Calculate opacity based on distance from active line
  const getOpacity = (index: number) => {
    if (activeIndex < 0) return 0.4;
    const distance = Math.abs(index - activeIndex);
    if (distance === 0) return 1;
    if (distance === 1) return 0.7;
    if (distance === 2) return 0.5;
    return 0.3;
  };

  // Calculate scale based on active state
  const getScale = (index: number) => {
    return index === activeIndex ? 1.05 : 1;
  };

  if (!lyrics.length) {
    return (
      <div className="h-[85vh] lg:h-[65vh] flex flex-col items-center justify-center text-white/50 select-none">
        {matchStatus === "matching" && (
          <div className="animate-pulse">Syncing Lyrics...</div>
        )}
      </div>
    );
  }

  return (
    <div
      ref={containerRef}
      className="relative h-[85vh] lg:h-[65vh] w-full overflow-y-auto overflow-x-hidden px-6 lg:px-12 py-8 scroll-smooth"
      style={{
        scrollbarWidth: "none",
        msOverflowStyle: "none",
      }}
    >
      <style>{`
        .lyrics-container::-webkit-scrollbar {
          display: none;
        }
      `}</style>

      <div className="flex flex-col items-start gap-6 min-h-full pl-0 lg:pl-4">
        {lyrics.map((line, index) => {
          if (line.isMetadata) return null;

          const isActive = index === activeIndex;
          const opacity = getOpacity(index);
          const scale = getScale(index);

          return (
            <div
              key={index}
              data-index={index}
              onClick={() => onSeekRequest(line.time, true)}
              className="cursor-pointer transition-all duration-500 ease-out text-left w-full max-w-4xl"
              style={{
                opacity,
                transform: `scale(${scale})`,
                fontSize: `${fontSize - 2}px`,
                lineHeight: 1.5,
              }}
            >
              {line.isInterlude || line.text === "..." ? (
                <div className="flex items-center justify-center gap-2 py-4">
                  <span className="w-2 h-2 rounded-full bg-white/40 animate-pulse" />
                  <span
                    className="w-2 h-2 rounded-full bg-white/40 animate-pulse"
                    style={{ animationDelay: "0.2s" }}
                  />
                  <span
                    className="w-2 h-2 rounded-full bg-white/40 animate-pulse"
                    style={{ animationDelay: "0.4s" }}
                  />
                </div>
              ) : (
                <>
                  {line.words && line.words.length > 0 ? (
                    // Word-by-word rendering
                    <div className="font-bold transition-all duration-300 flex flex-wrap gap-x-2">
                      {line.words.map((word, wordIndex) => {
                        const currentWordIndex = isActive ? getCurrentWordIndex(index) : -1;
                        const isWordActive = isActive && wordIndex <= currentWordIndex;
                        
                        return (
                          <span
                            key={wordIndex}
                            className="transition-colors duration-200"
                            style={{
                              color: isWordActive ? accentColor : 'rgba(255, 255, 255, 0.5)',
                            }}
                          >
                            {word.text}
                          </span>
                        );
                      })}
                    </div>
                  ) : (
                    // Fallback: whole line rendering
                    <div
                      className="font-bold transition-all duration-300"
                      style={{
                        color: isActive ? accentColor : 'rgba(255, 255, 255, 0.5)',
                      }}
                    >
                      {line.text}
                    </div>
                  )}
                  {line.translation && (
                    <div
                      className="text-white/60 mt-2 transition-all duration-300"
                      style={{ fontSize: `${fontSize * 0.6}px` }}
                    >
                      {line.translation}
                    </div>
                  )}
                </>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
};

export default LyricsViewSimple;
