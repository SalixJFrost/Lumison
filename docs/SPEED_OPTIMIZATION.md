# 倍速功能优化文档

## 更新概览

本次更新对音乐播放器的倍速功能进行了全面优化，支持三倍速播放，并针对桌面端和移动端进行了性能优化。

## 主要改进

### 1. 扩展倍速范围 (0.5x - 3x)
- 原范围：0.5x - 2x
- 新范围：0.5x - 3x
- 支持更灵活的播放速度调整

### 2. 快速预设按钮
在设置弹窗中新增快速预设功能：
- 0.5x（慢速）
- 0.75x
- 1x（正常）
- 1.25x
- 1.5x（快速）
- 2x（很快）
- 2.5x
- 3x（超快）

点击"Speed"标签即可展开预设菜单，快速切换到常用倍速。

### 3. 键盘快捷键增强

#### 新增快捷键：
- `Shift + ↑/↓`：增加/减少倍速（步进 0.25x）
- `Ctrl/Cmd + 0-3`：快速切换预设倍速
  - `Ctrl + 0`：1x（正常速度）
  - `Ctrl + 1`：1.5x
  - `Ctrl + 2`：2x
  - `Ctrl + 3`：3x
- `R`：重置倍速到 1x

### 4. 视觉反馈优化

#### 速度指示器
新增浮动速度指示器，在调整倍速时显示：
- 实时显示当前倍速值
- 颜色编码：
  - 蓝色：慢速（< 1x）
  - 绿色：正常（1x）
  - 黄橙色：快速（1-2x）
  - 红粉色：超快（> 2x）
- 速度标签：Slow / Normal / Fast / Very Fast / Ultra Fast
- 进度条显示当前速度在范围内的位置
- 自动隐藏（1.5秒后）

### 5. 移动端触摸优化

#### 触摸手势支持
- 在速度滑块上支持触摸拖动
- 优化触摸响应速度
- 防止误触和滑动冲突

#### 响应式设计
- 预设菜单支持滚动（移动端）
- 自适应布局，适配不同屏幕尺寸

### 6. 性能优化

#### 平滑速度过渡
- 小幅度调整（< 0.5x）：使用 requestAnimationFrame 实现平滑过渡
- 大幅度调整（≥ 0.5x）：立即应用，提升响应速度
- 高倍速（> 2x）：优化处理，确保流畅播放

#### 内存优化
- 使用 useRef 管理定时器，避免内存泄漏
- 组件卸载时自动清理资源
- 优化动画性能，减少重绘

## 使用指南

### 桌面端操作

1. **鼠标操作**
   - 点击设置图标打开设置弹窗
   - 拖动垂直滑块调整倍速
   - 点击"Speed"展开预设菜单
   - 使用鼠标滚轮微调倍速

2. **键盘操作**
   - `S`：打开/关闭设置弹窗
   - `Shift + ↑/↓`：快速调整倍速
   - `Ctrl + 0-3`：切换预设倍速
   - `R`：重置到正常速度

### 移动端操作

1. **触摸操作**
   - 点击设置图标打开设置弹窗
   - 在滑块上上下滑动调整倍速
   - 点击"Speed"查看预设选项
   - 点击预设按钮快速切换

2. **视觉反馈**
   - 调整倍速时会显示浮动指示器
   - 指示器颜色和标签反映当前速度等级
   - 1.5秒后自动隐藏

## 技术实现

### 核心组件

1. **Controls.tsx**
   - 扩展倍速范围到 3x
   - 新增预设菜单
   - 优化触摸事件处理

2. **usePlayer.ts**
   - 实现平滑速度过渡算法
   - 优化高倍速性能
   - 使用 requestAnimationFrame 提升流畅度

3. **KeyboardShortcuts.tsx**
   - 新增倍速相关快捷键
   - 更新快捷键帮助文档

4. **SpeedIndicator.tsx**（新增）
   - 浮动速度指示器组件
   - 动画效果和颜色编码
   - 自动显示/隐藏逻辑

5. **App.tsx**
   - 集成速度指示器
   - 统一速度变更处理
   - 定时器管理和清理

### 性能优化策略

1. **渐进式速度应用**
   ```typescript
   // 小幅调整：平滑过渡
   if (Math.abs(targetSpeed - currentRate) < 0.5) {
     audio.playbackRate = currentRate + diff * 0.15;
   }
   // 大幅调整：立即应用
   else {
     audio.playbackRate = targetSpeed;
   }
   ```

2. **防抖和节流**
   - 速度指示器使用定时器防抖
   - 触摸事件优化，减少不必要的更新

3. **资源清理**
   - 组件卸载时清理定时器
   - 取消未完成的动画帧

## 浏览器兼容性

- Chrome/Edge：完全支持
- Firefox：完全支持
- Safari：完全支持
- 移动浏览器：完全支持

## 已知限制

1. 某些音频格式在高倍速（> 2.5x）下可能出现轻微失真
2. 极低倍速（< 0.7x）下，部分浏览器可能有音质下降
3. 建议在 1-2x 范围内使用以获得最佳音质

## 未来改进方向

1. 添加自定义预设功能
2. 支持记忆每首歌的倍速设置
3. 添加倍速曲线调整（非线性变速）
4. 集成音频增强算法，改善高倍速音质

## 反馈与支持

如有问题或建议，请通过以下方式联系：
- 提交 Issue
- 发送反馈邮件
- 参与社区讨论
