# Lumison 歌词系统

## 概述

Lumison 采用多源歌词系统，支持多种歌词来源并智能选择最佳歌词。

## 歌词来源优先级

系统会按照以下优先级自动选择最佳歌词来源：

### 1️⃣ 内嵌歌词（ID3/FLAC 标签）- 最高优先级

- **优先级**: 最高
- **优势**: 歌词随音频文件一起，最可靠，无需额外文件或网络
- **推荐**: 对于本地音乐库，这是最方便和最可靠的方式

支持以下标签格式：

#### MP3 (ID3v2)
- **USLT** (Unsynchronized Lyrics) - 纯文本歌词
- **SYLT** (Synchronized Lyrics) - 带时间戳的同步歌词
- **LYRICS** - 通用歌词标签

#### FLAC (Vorbis Comments)
- **LYRICS** - 歌词字段
- **UNSYNCEDLYRICS** - 非同步歌词

### 2️⃣ 在线歌词 API - 次优先级（备用）

#### 搜索策略：并行搜索，最快响应优先

系统会同时向多个平台发起请求，使用最快返回的结果。如果网易云音乐有结果，会优先使用（因为支持逐字歌词和翻译）。

#### 平台列表：

**主要平台（并行搜索）：**

1. **网易云音乐（Netease Music）** - 默认启用 ✅
   - 最稳定可靠
   - 支持逐字歌词（YRC）
   - 支持翻译歌词
   - 多个镜像 API 自动选择最快的
   - 中文歌曲覆盖最全

2. **第三方歌词 API（并行搜索多个源）** - 默认启用 ✅
   
   **商业/公共 API：**
   - **LrcLib** (https://lrclib.net) - 最大的开源歌词库，支持同步歌词
   - **LRCAPI** (https://lrc.xms.mx) - 支持多语言，LRC 格式
   - **Lyrics.ovh** - 简单但覆盖广泛，纯文本转 LRC
   - **Syair.info** - 亚洲音乐覆盖好
   - **ChartLyrics** - 免费，支持部分同步歌词
   - **Musixmatch** - 全球最大歌词库，支持精确同步（公共端点）
   
   **开源歌词库/数据库：**
   - **OpenLyrics** - 开源 LRC 歌词 XML 规范，支持 SYLT/LRC
   - **LyricWiki** - 歌词百科社区镜像
   
   适合国际歌曲和网易云没有版权的歌曲（如周杰伦）

**备用平台（仅在主要平台失败时使用）：**

3. **QQ 音乐** - 默认禁用 ❌
   - 由于 CORS 问题频繁失败
   - 可手动启用（见下方配置）

4. **酷狗音乐** - 默认禁用 ❌
   - 由于 CORS 问题频繁失败
   - 可手动启用（见下方配置）

#### 平台配置

在浏览器控制台中，你可以查看和修改平台配置：

```javascript
// 查看当前配置
import { getPlatformConfig } from './services/music';
getPlatformConfig();

// 启用 QQ 音乐和酷狗音乐（如果你有可用的代理）
import { updatePlatformConfig } from './services/music';
updatePlatformConfig({ qq: true, kugou: true });

// 禁用第三方 API
updatePlatformConfig({ thirdParty: false });
```

**优势**：
- **并行搜索**：网易云和第三方 API 同时搜索，速度更快
- **覆盖更广**：8+ 个第三方源，包括开源歌词库
- **智能选择**：优先使用网易云的逐字歌词，但不会因为网易云没有而放弃搜索

**注意**：
- **触发条件**: 仅当没有内嵌歌词时才会自动查询
- **匹配方式**: 标题 + 艺术家
- **缓存**: 自动缓存到本地
- **CORS 问题**: QQ 音乐和酷狗音乐因浏览器跨域限制经常失败，因此默认禁用

### 3️⃣ 外部 LRC 文件 - 最低优先级（最后备用）

- **格式**: `.lrc` 或 `.txt`
- **匹配方式**: 
  - 精确匹配：文件名与音频文件名完全相同
  - 模糊匹配：使用 Levenshtein 距离算法（相似度 ≥ 70%）
- **使用场景**: 当内嵌歌词和在线API都失败时的最后备用

## 技术实现

- 使用 `jsmediatags` 库解析 ID3 标签
- 自动检测并提取所有支持的歌词格式
- 并行搜索多个在线平台
- 智能缓存机制
- 支持逐字歌词（YRC）和翻译

## 最佳实践

1. **本地音乐**: 使用支持歌词标签的音乐管理软件（如 MusicBee、foobar2000）为音频文件添加内嵌歌词
2. **在线搜索**: 系统会自动搜索，无需手动操作
3. **外部文件**: 将 LRC 文件与音频文件放在同一目录，使用相同文件名
